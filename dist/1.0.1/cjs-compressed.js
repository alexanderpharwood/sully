"use strict";window.document||fatalError("Sully requires a window with a document");var Sully={};function fatalError(e){throw Sully.domContainer.innerHTML='<h3 id="exceptionMessage">'+Sully.exceptionMessage+"</h3>",new Error(e)}function getBasePath(e){return(Sully.basePath+e).replace("//","/")}function parseQueryString(){var e=getQueryString();if(void 0!==e)return e.split("&").reduce(function(e,r){var o=r.split("=");return e[o[0]]=o[1],e},{})}function getQueryString(){var e=window.location.search;if(""!==e)return e.substr(1,e.length)}function getRouteFromUrl(){var e;return""===(e=Sully.html5Routing?window.location.pathname.replace(Sully.basePath,""):window.location.hash.substr(1,window.location.hash.length))&&(e=void 0),e}function loadController(e){if(void 0!==e.middleware&&e.middleware.constructor===Array)for(var r in e.middleware)Sully.middlewareProvider[e.middleware[r]].run(e.requestData);void 0!==Sully.controllerProvider[e.controller].constructor&&Sully.controllerProvider[e.controller].constructor(e.requestData),Sully.controllerProvider[e.controller][e.method](e.requestData)}function routeFromUrl(){var e=!1,r={};for(var o in r.route=getRouteFromUrl(),r.requestData={},void 0!==r.route&&""!==r.route||(r.route="/"),Sully.routeProvider){var t=Sully.routeProvider[o].route,l=t.match(/{(.*?)}/g),n=new RegExp("^"+t.replace(/{(.*?)}/g,"(.*?)").replace(new RegExp("/","g"),"\\/?")+"(/*)?$","g");if(null!=r.route.match(n)){var u=n.exec(r.route);r.controller=Sully.routeProvider[o].controller,r.method=Sully.routeProvider[o].method,r.middleware=Sully.routeProvider[o].middleware,r.route=o,e=!0}if(e)break}if(e){var i=1;for(var o in l){var a=l[o].substr(1,l[o].length-2);r.requestData[a]=u[i],i++}}else r.controller=Sully.notFoundRoute.controller,r.method=Sully.notFoundRoute.method,r.middleware=Sully.notFoundRoute.middleware;void 0!==getQueryString()&&(r.requestData.queryData=parseQueryString()),loadController(r)}Sully.domContainer={},Sully.controllerProvider={},Sully.middlewareProvider={},Sully.viewProvider={},Sully.routeProvider={},Sully.notFoundRoute={},Sully.html5Routing=!1,Sully.exceptionMessage="Oops! An error occured processing your request.",Sully.routeTo=function(e){Sully.html5Routing?window.history.pushState({},null,getBasePath(e)):window.location.hash=e,routeFromUrl()},Sully.registerNotFound=function(e,r){Sully.notFoundRoute.controller=e,Sully.notFoundRoute.method=r},Sully.registerView=function(e,r){Sully.viewProvider[e]=r},Sully.registerRoute=function(e){Sully.routeProvider[e.name]={route:e.route,controller:e.controller,method:e.method,middleware:e.middleware}},Sully.registerController=function(e,r){Sully.controllerProvider[e]=r},Sully.registerMiddleware=function(e,r){Sully.middlewareProvider[e]=r},Sully.getView=function(e){return Sully.viewProvider[e]},String.prototype.buildView=function(e){return Sully.buildView(this,e)},Sully.buildView=function(e,r){void 0===e&&fatalError("Template is undefined");var o=(e=e.replace(/(\r\n|\n|\r)/gm,"")).match(/{{(.*?)}}/g);for(var t in o){o[t]=o[t].substr(2,o[t].length-4),o[t].trim();var l=o[t].split(":",1)[0];switch(l){case"view":var n=Sully.viewProvider[o[t].substr(l.length+1,o[t].length)];e=e.replace("{{"+o[t]+"}}",Sully.buildView(n,r));break;default:e=e.replace("{{"+o[t]+"}}",void 0!==r[o[t]]?r[o[t]]:"")}}return e},Sully.renderView=function(e,r,o){void 0===e&&fatalError("Template is undefined"),Sully.domContainer.innerHTML=e,(void 0===o||o)&&(document.body.scrollTop=document.documentElement.scrollTop=0),void 0!==r&&r&&r()},Sully.serveView=function(e,r,o,t){var l=Sully.getView(e);void 0===l&&fatalError("View '"+e+"' not found"),l=Sully.buildView(l,r),Sully.renderView(l,o,t)},Sully.init=function(e){void 0===document.getElementsByTagName("base")[0]&&fatalError("Missing <base> tag in html."),Sully.basePath=document.getElementsByTagName("base")[0].getAttribute("href"),Sully.domContainer=document.getElementById(e.container),void 0!==e.exceptionMessage&&(Sully.exceptionMessage=e.exceptionMessage),window.history&&history.pushState?(window.onpopstate=function(e){routeFromUrl()},window.history.replaceState({},null,window.location.path),Sully.html5Routing=!0):(window.onhashchange=function(){routeFromUrl()},Sully.html5Routing=!1),document.addEventListener("click",function(e){var r=e.path||e.composedPath&&e.composedPath()||e.deepPath();for(var o in r)if("A"===r[o].nodeName&&!r[o].classList.contains("no-route-catch")){e.preventDefault();var t=r[o].getAttribute("href");Sully.routeTo(t)}}),routeFromUrl()},module.exports=Sully;