!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):e.Sully=o()}(this,function(){"use strict";var s={};function w(e){return void 0===e}function d(e){throw s.domContainer.innerHTML='<h3 id="exceptionMessage">'+s.exceptionMessage+"</h3>",new Error(e)}function f(e){return(s.basePath+e).replace("//","/")}function m(){var e=window.location.search;if(""!==e)return e.substr(1,e.length)}function h(){return window.location.pathname.replace(s.basePath,"")}function v(){return window.location.hash.substr(1,window.location.hash.length)}function g(e){if(!w(e.middleware)&&((r=e.middleware.constructor)&&"object"==typeof r&&r.constructor===Array))for(var o in e.middleware)s.middlewareProvider[e.middleware[o]].run(e.request);var r;w(s.controllerProvider[e.controller].constructor)||s.controllerProvider[e.controller].constructor(e.request),s.controllerProvider[e.controller][e.method](e.request)}function o(){var e=!1,o={};if(o.route=s.html5Routing?h():v(),s.html5Routing){if(""!==v()&&""===h()){var r="/"+v();return window.location.replace(window.location.origin+f(r))}}else if(""===v()&&""!==h()){var t="#/"+h();return window.location.replace(window.location.origin+f(t))}for(var n in o.request={},o.request.url=window.location.href,(w(o.route)||""===o.route)&&(o.route="/"),s.routeProvider){var i=s.routeProvider[n].route,u=i.match(/{(.*?)}/g),d=new RegExp("^"+i.replace(/{(.*?)}/g,"(.*?)").replace(new RegExp("/","g"),"\\/?")+"(/*)?$","g");if(null!=o.route.match(d)){var a=d.exec(o.route);o.controller=s.routeProvider[n].controller,o.method=s.routeProvider[n].method,o.middleware=s.routeProvider[n].middleware,o.route=n,e=!0}if(e)break}if(e){var c=1;for(var n in u){var l=u[n].substr(1,u[n].length-2);o.request[l]=a[c],c++}}else o.controller=s.notFoundRoute.controller,o.method=s.notFoundRoute.method,o.middleware=s.notFoundRoute.middleware;w(m())||(o.request.queryData=function(){var e=m();if(!w(e))return e.split("&").reduce(function(e,o){var r=o.split("=");return e[r[0]]=r[1],e},{})}()),g(o)}return s.domContainer={},s.controllerProvider={},s.middlewareProvider={},s.viewProvider={},s.routeProvider={},s.notFoundRoute={},s.html5Routing=!1,s.exceptionMessage="Oops! An error occured processing your request.",s.routeTo=function(e){if(window.location.origin+f(e)===window.location.href)return!1;s.html5Routing?window.history.pushState({},null,f(e)):window.location.hash=e,o()},s.registerNotFound=function(e,o){s.notFoundRoute.controller=e,s.notFoundRoute.method=o},s.registerView=function(e,o){s.viewProvider[e]=o},s.registerRoute=function(e){s.routeProvider[e.name]={route:e.route,controller:e.controller,method:e.method,middleware:e.middleware}},s.registerController=function(e,o){s.controllerProvider[e]=o},s.registerMiddleware=function(e,o){s.middlewareProvider[e]=o},s.getView=function(e){return s.viewProvider[e]},String.prototype.buildView=function(e){return s.buildView(this,e)},s.buildView=function(e,o){var r;w(e)&&d("Template is undefined"),(r=o)&&"object"==typeof r&&r.constructor===Object||(o={});var t=(e=e.replace(/(\r\n|\n|\r)/gm,"")).match(/{{(.*?)}}/g);for(var n in t){t[n]=t[n].substr(2,t[n].length-4),t[n].trim();var i=t[n].split(":",1)[0];switch(i){case"view":var u=s.viewProvider[t[n].substr(i.length+1,t[n].length)];e=e.replace("{{"+t[n]+"}}",s.buildView(u,o));break;default:e=e.replace("{{"+t[n]+"}}",w(o[t[n]])?"":o[t[n]])}}return e},s.renderView=function(e,o,r){w(e)&&d("Template is undefined"),s.domContainer.innerHTML=e,r&&(document.body.scrollTop=document.documentElement.scrollTop=0),"function"==typeof o&&o()},s.serveView=function(e,o,r,t){var n=s.getView(e);w(n)&&d("View '"+e+"' not found"),n=s.buildView(n,o),s.renderView(n,r,t)},s.init=function(e){window.document||d("Sully requires a window with a document"),w(document.getElementsByTagName("base")[0])&&d("Missing <base> tag in html."),s.basePath=document.getElementsByTagName("base")[0].getAttribute("href"),s.domContainer=document.getElementById(e.container),w(e.exceptionMessage)||(s.exceptionMessage=e.exceptionMessage),window.history&&history.pushState?(window.onpopstate=function(e){o()},window.history.replaceState({},null,window.location.path),s.html5Routing=!0):(window.onhashchange=function(){o()},s.html5Routing=!1),document.addEventListener("click",function(e){var o=e.path||e.composedPath&&e.composedPath()||e.deepPath();for(var r in o)if("A"===o[r].nodeName&&!o[r].classList.contains("no-route-catch")){e.preventDefault();var t=o[r].getAttribute("href");s.routeTo(t)}}),o()},s});